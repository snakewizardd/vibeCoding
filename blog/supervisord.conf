; /etc/supervisor/conf.d/supervisord.conf
[supervisord]
nodaemon=true ; Keep supervisord in the foreground so Docker doesn't exit

[program:postgres]
; Use the command appropriate for your Postgres version (e.g., 14 in the Dockerfile example)
command=su postgres -c "/usr/lib/postgresql/14/bin/postgres -D /var/lib/postgresql/data"
user=root ; Run as root to use 'su postgres', or configure user management properly
autostart=true
autorestart=true
stdout_logfile=/var/log/supervisor/postgres.log
stderr_logfile=/var/log/supervisor/postgres.err
; Give Postgres some time to initialize and start listening
startsecs=5
startretries=3

[program:backend]
; Command to run the production Python web server (Gunicorn)
command=gunicorn -w 4 -k uvicorn.workers.UvicornWorker app.main:app --bind 127.0.0.1:8000
directory=/app ; Set working directory to the app directory
autostart=true
autorestart=true
stdout_logfile=/var/log/supervisor/backend.log
stderr_logfile=/var/log/supervisor/backend.err
; Pass environment variables specific to this program
environment=POSTGRES_USER=user,POSTGRES_PASSWORD=password,POSTGRES_DB=retro_journal_db,DB_HOST=127.0.0.1,DB_PORT=5432
; Delay starting the backend until postgres is likely up
startsecs=15
startretries=5

[program:nginx]
; Command to run Nginx in the foreground
command=nginx -g "daemon off;"
autostart=true
autorestart=true
stdout_logfile=/var/log/supervisor/nginx.log
stderr_logfile=/var/log/supervisor/nginx.err
; Delay starting nginx until the backend is likely up (so it can proxy)
startsecs=20